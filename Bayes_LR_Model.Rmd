---
title: "Personal Loan Acceptance - Bayesian Predictive Analysis"
author: "Juan José Alvarado"
output: github_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE,
                      fig.align = 'center',
                      fig.width = 6,
                      fig.height = 5)

library(tidyverse)
library(tidybayes)
library(patchwork)
library(gt)
library(brms)
```

# Introduction

This project aims to identify which factors (predictors) influence the decision of a financial institution - like a bank - when granting a personal loan (variable of interest) to its clients. This kind of information can be used to optimize marketing campaigns, targeting specific demographics. To do so, a *Bayesian Logistic Regression Model* was implemented using the R package *"bmrs¨*. The analysis indicated this predictors as the most significant: *Educational Level (Graduate and Professional), family size and income*. The AUC (**0.949**) reveals the model has a great predictive capacity.

## Key Aspects of the Project

-   Bayesian Logistic Regression Model (with *brms* package)
-   Posterior Distribution and Odds Ratios Analysis and Interpretation
-   MCMC chains convergence diagnostics (**R-hat**, **Trace Plots**)
-   Model Performance Evaluation using ROC/AUC curve and Posterior Predictive Checks
-   Cleaning, pre process and data visualization

The bank wants to improve marketing campaigns efficiency when offering personal loans; instead of reaching out every single client in the data base (costly) it is needed a way to identify those clients with a higher probability of accepting a personal loan. The model seeks to create a profile of the *ideal client*, channeling the marketing efforts and increase returns.

# Data

Data set was retrieved from the *Kaggle* platform under the name: "[Bank Personal Loan Modelling](https://www.kaggle.com/datasets/itsmesunil/bank-loan-modelling)". It contains demographic and banking information of 5,000 clients.

## Pre process

-   The column names were standardized (easier manipulation)
-   Categorical variables were converted to factor type
-   *id* and *zip_code* variables were excluded as they are not relevant predictors.

```{r eval=TRUE, include=TRUE, echo=FALSE}
# Data Load and Exploration (EDA) ----
bank_data <- read_csv("Bank_Personal_Loan_Modelling.csv")

# Data Cleaning and Pre Process
loan <- bank_data %>% 
  janitor::clean_names() #clean column names

loan <- loan %>%  #Converting categorical variables to factors
  mutate(
    education = factor(education, levels = c(1, 2, 3), labels = c("Undergraduate", "Graduate", "Professional")),
    securities_account = factor(securities_account, levels = c(0, 1), labels = c("No", "Yes")),
    cd_account = factor(cd_account, levels = c(0, 1), labels = c("No", "Yes")),
    online = factor(online, levels = c(0, 1), labels = c("No", "Yes")),
    credit_card = factor(credit_card, levels = c(0, 1), labels = c("No", "Yes")),
    personal_loan = factor(personal_loan, levels = c(0, 1), labels = c("No", "Yes")) #Target Variable
  ) %>% 
  select(-id, -zip_code)

head(loan)
```

## EDA Visualizations

A brief EDA revealed a rather strong relation between the variables family size and educational level. As you can observe in the following graph, the distribution of graduates, professionals and clients with a *large* family size seems high.

```{r eval=TRUE, include=TRUE, echo=FALSE}
plot_1st <- ggplot(loan, aes(x = personal_loan, y = family, fill = personal_loan)) +
  geom_boxplot(alpha = 0.7) +
  labs(
    title = "Family size vs Loan Acceptance",
    x = "Accepted the loan?",
    y = "Number of members"
  ) +
  theme_minimal() +
  theme(legend.position = "none")

plot_1st
```

```{r eval=TRUE, include=TRUE, echo=FALSE}
plot_2nd <- ggplot(loan, aes(x = education, fill = personal_loan)) +
  geom_bar(position = "fill") +
  labs(
    title = "Educational Level vs Loan Acceptance",
    x = "Educational Level",
    y = "Proportion"
  ) +
  scale_y_continuous(labels = scales::percent) +
  theme_minimal()

plot_2nd
```

# Creating a Model

As the variable of interest (*personal_loan*) contains binary data a *logistic regression model* (for binary classification) was used. With limited information and wanting to incorporate prior knowledge, the Bayesian approach was selected. This helps us to provide a probability distribution to each model predictor and therefore extract more robust estimates of uncertainty.

## Priors and Diagnostics

To ensure model regularization and avoid over adjustment, *weakly informative priors* were used (*Normal(0, 2.5)*) for the coefficients (predictors). After adjusting the model the MCMC chains convergence was verified (*R_hat close to 1*) and the following trace graphs didn't show any odd pattern(s), we could secure the results reliability.

![Intercept and Predictor 1](model1.png)
![Predictors 2](model2.png)
![Predictor 3](model3.png)

# Results

## Model Odd Ratios
```{r eval=TRUE, include=TRUE, echo=FALSE}
priors <- c(
  set_prior("normal (0, 2.5)", class = "b"),  #For all the coefficients (columns)
  set_prior("normal (0, 5)", class = "Intercept") #For personal_loan (intercept)
)

# Defining and adjusting the model 
loan_model <- brm(
  formula = personal_loan ~ income + family + cc_avg + education + mortgage + credit_card + online,
  data = loan,
  family = bernoulli(link = "logit"),
  prior = priors,
  chains = 4,
  iter = 2000,
  warmup = 1000,
  seed = 001
)
```

```{r eval=TRUE, include=TRUE, echo=FALSE, message=FALSE}
# Odd Ratio Conversion
loan_model %>% 
  gather_draws(b_Intercept, b_income, b_family, `b_education.*`, regex = TRUE) %>% 
  mutate(odds_ratio = exp(.value)) %>%
  reframe(
    median_or= median(odds_ratio),
    lower_ci = quantile(odds_ratio, 0.025),
    upper_ci = quantile(odds_ratio, 0.975)
  ) %>%
  distinct() %>% 
  gt() %>% 
  tab_header(title = "Model Odd Ratios Resume") %>% 
  fmt_number(columns = c(median_or, lower_ci, upper_ci), decimals = 2)
```

- Being graduated and professional increases the odds up to **50 times!** when accepting a personal loan.
- Having one more family member adds up to 80% in the odds also.
- Lastly, clients with relatively high income increases only 6% the odds of accepting a personal loan.

## Other Predictors Posterior Distributions
```{r eval=TRUE, include=TRUE, echo=FALSE}
posterior <- as_draws_df(loan_model)
```

```{r eval=TRUE, include=TRUE, echo=FALSE}
ggplot(posterior, aes(x = b_cc_avg)) +
  stat_halfeye() +
  labs(title = "Posterior Distribution: Average Credit Card Expenditure (cc_avg)")
```

```{r eval=TRUE, include=TRUE, echo=FALSE}
ggplot(posterior, aes(x = b_mortgage)) +
  stat_halfeye() +
  labs(title = "Posterior Distribution: Mortgage")
```

```{r eval=TRUE, include=TRUE, echo=FALSE}
ggplot(posterior, aes(x = b_credit_cardYes)) +
  stat_halfeye() +
  labs(title = "Posterior Distribution: Has a Credit Card")
```

```{r eval=TRUE, include=TRUE, echo=FALSE}
ggplot(posterior, aes(x = b_onlineYes)) +
  stat_halfeye() +
  labs(title = "Posterior Distribution: Use online service")
```

# Model Evaluation

The predictive performance of the model was evaluated using the Receiver Operating Characteristic Curve (ROC) and the Area under that Curve (AUC). The value of **AUC = 0.9491** indicates a great discriminatory (clients who accept or don't) capacity.

```{r eval=TRUE, include=TRUE, echo=FALSE}
pred_prob <- posterior_epred(loan_model)

prob_mean <- apply(pred_prob, 2, mean)

results <- tibble(
  observed = loan_model$data$personal_loan,
  predicted_prob = prob_mean
)

roc_curve <- pROC::roc(observed ~ predicted_prob, data = results) 
auc_value <- pROC::auc(roc_curve)
```


```{r eval=TRUE, include=TRUE, echo=FALSE}
pROC::ggroc(roc_curve) +
  labs(
    title = "Loan Model ROC Curve",
    subtitle = paste("AUC:", round(auc_value, 3))
  ) +
  theme_minimal()
```

# Conclusions

The Bayesian approach to the Lineal Regression Model helped constructing a robust client profile (**highly educated, with "large" family and above average income**) with a high chance of accepting a personal loan. A bank's marketing department could use these kind of modeling results to segment its clients and focus future campaigns in order to increase potential investments returns.